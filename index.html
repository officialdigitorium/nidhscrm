<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#7c3aed">
    <title>NIDHS DESIGN CRM</title>
    <meta name="description" content="NIDHS DESIGN CRM ‚Äî Manage clients, projects, payments & deliverables.">
    <meta property="og:title" content="NIDHS DESIGN CRM">
    <meta property="og:description" content="Design Studio Client Management ‚Äî Projects, Payments & Deliverables">
    <meta property="og:image" content="og-image.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="NIDHS DESIGN CRM">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="NIDHS DESIGN CRM">
    <meta name="twitter:description" content="Design Studio Client Management">
    <meta name="twitter:image" content="og-image.png">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='22' fill='%237c3aed'/%3E%3Ctext x='50' y='68' font-family='Arial,sans-serif' font-weight='800' font-size='55' fill='white' text-anchor='middle'%3EN%3C/text%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='22' fill='%237c3aed'/%3E%3Ctext x='50' y='68' font-family='Arial,sans-serif' font-weight='800' font-size='55' fill='white' text-anchor='middle'%3EN%3C/text%3E%3C/svg%3E">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        *,*::before,*::after{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;-webkit-font-smoothing:antialiased}
        :root{--b:#7c3aed;--b2:#a855f7;--bg:#faf9fb;--bg2:#f3f1f5;--card:#fff;--text:#1a1a2e;--t2:#6b7280;--t3:#9ca3af;--brd:#f0eef2;--brd2:#e5e3e8;--grn:#059669;--red:#dc2626;--amb:#d97706;--pnk:#ec4899;--sh:0 1px 3px rgba(0,0,0,.04);--sb:env(safe-area-inset-bottom,0px);--st:env(safe-area-inset-top,0px);--nh:72px;--hh:60px}
        [data-theme="dark"]{--bg:#0f0d13;--bg2:#1a1720;--card:#1e1b25;--text:#e8e6ef;--t2:#9b97a5;--t3:#6b6778;--brd:#2a2733;--brd2:#353140;--sh:0 1px 3px rgba(0,0,0,.2)}
        html{height:100%}
        body{font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);height:100%;margin:0;font-size:14px;line-height:1.5;overflow:hidden;transition:background .3s,color .3s}
        #splash{position:fixed;inset:0;background:var(--card);z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:opacity .3s,visibility .3s}
        #splash.hide{opacity:0;visibility:hidden;pointer-events:none}
        .slogo{width:68px;height:68px;background:linear-gradient(135deg,var(--b),var(--b2));border-radius:20px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:28px;margin-bottom:20px;animation:pulse 1.5s ease infinite;overflow:hidden}
        .slogo img{width:100%;height:100%;object-fit:cover}
        @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
        .sbar{width:120px;height:4px;background:var(--brd);border-radius:4px;overflow:hidden;margin-top:16px}
        .sbar-in{width:40%;height:100%;background:linear-gradient(90deg,var(--b),var(--b2));border-radius:4px;animation:sload 1s ease infinite}
        @keyframes sload{0%{transform:translateX(-100%)}100%{transform:translateX(350%)}}
        #setup{position:fixed;inset:0;background:var(--bg);z-index:9998;display:none;overflow-y:auto;-webkit-overflow-scrolling:touch}
        .setup-in{min-height:100%;display:flex;align-items:center;justify-content:center;padding:24px 16px}
        .setup-box{background:var(--card);border-radius:24px;padding:32px 24px;width:100%;max-width:400px;box-shadow:var(--sh)}
        #app{display:none;height:100%;flex-direction:column;overflow:hidden}
        #app.show{display:flex}
        .hdr{height:var(--hh);padding-top:var(--st);background:rgba(255,255,255,.92);-webkit-backdrop-filter:blur(20px);backdrop-filter:blur(20px);border-bottom:1px solid var(--brd);display:flex;align-items:center;padding-left:16px;padding-right:16px;gap:10px;flex-shrink:0;z-index:50;min-height:var(--hh);transition:background .3s}
        [data-theme="dark"] .hdr{background:rgba(30,27,37,.92)}
        .hdr-logo{width:36px;height:36px;background:linear-gradient(135deg,var(--b),var(--b2));border-radius:10px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:16px;flex-shrink:0;overflow:hidden}
        .hdr-logo img{width:100%;height:100%;object-fit:cover}
        .hdr-t{flex:1;font-weight:700;font-size:17px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .hdr-btn{width:36px;height:36px;border-radius:10px;border:none;background:var(--bg2);display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;color:var(--t2);transition:all .15s}
        .hdr-btn:active{transform:scale(.95)}
        .main{flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;overscroll-behavior-y:contain;position:relative;min-height:0}
        .main-in{padding:16px;padding-bottom:calc(var(--nh) + var(--sb) + 30px);max-width:800px;margin:0 auto}
        .nav{position:fixed;bottom:0;left:0;right:0;height:calc(var(--nh) + var(--sb));padding-bottom:var(--sb);background:rgba(255,255,255,.95);-webkit-backdrop-filter:blur(20px);backdrop-filter:blur(20px);border-top:1px solid var(--brd);display:flex;align-items:stretch;z-index:100;transition:background .3s}
        [data-theme="dark"] .nav{background:rgba(30,27,37,.95)}
        .nav-b{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;background:none;border:none;cursor:pointer;color:var(--t3);font-size:10px;font-weight:600;transition:color .15s;padding:8px 0}
        .nav-b svg{width:22px;height:22px;flex-shrink:0}
        .nav-b.on{color:var(--b)}
        .nav-fab{width:52px;height:52px;background:linear-gradient(135deg,var(--b),var(--b2));border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;border:none;cursor:pointer;box-shadow:0 4px 20px rgba(124,58,237,.4);margin-top:-20px;align-self:flex-start;flex-shrink:0;transition:transform .15s}
        .nav-fab:active{transform:scale(.92)}
        .nav-fab svg{width:26px;height:26px;flex-shrink:0}
        .cd{background:var(--card);border-radius:16px;border:1px solid var(--brd);margin-bottom:12px;overflow:hidden;box-shadow:var(--sh);transition:background .3s,border-color .3s}
        .cd-p{padding:16px}
        .fld{margin-bottom:14px}
        .fld-l{display:block;font-size:11px;font-weight:700;color:var(--t3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px}
        .fld-i{width:100%;padding:12px 14px;background:var(--bg2);border:2px solid transparent;border-radius:12px;font-size:15px;font-weight:500;color:var(--text);outline:none;transition:all .15s;-webkit-appearance:none;appearance:none;font-family:inherit}
        .fld-i:focus{background:var(--card);border-color:var(--b);box-shadow:0 0 0 3px rgba(124,58,237,.1)}
        .fld-i::placeholder{color:var(--t3);font-weight:400}
        textarea.fld-i{resize:vertical;min-height:80px}
        select.fld-i{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%239ca3af' stroke-width='2'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;padding-right:36px}
        .btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:12px 20px;border-radius:12px;font-weight:600;font-size:14px;border:none;cursor:pointer;transition:all .15s;font-family:inherit;white-space:nowrap}
        .btn:active{transform:scale(.97)}
        .btn svg{width:16px;height:16px;flex-shrink:0}
        .btn-b{background:linear-gradient(135deg,var(--b),var(--b2));color:#fff;box-shadow:0 4px 12px rgba(124,58,237,.3)}
        .btn-g{background:var(--bg2);color:var(--text)}.btn-g:active{background:var(--brd)}
        .btn-o{background:transparent;border:1.5px solid var(--brd);color:var(--t2)}.btn-o:active{background:var(--bg2)}
        .btn-gn{background:#ecfdf5;color:var(--grn)}
        .btn-rd{background:#fef2f2;color:var(--red)}
        [data-theme="dark"] .btn-gn{background:rgba(5,150,105,.15)}
        [data-theme="dark"] .btn-rd{background:rgba(220,38,38,.15)}
        .btn-s{padding:8px 12px;font-size:12px;border-radius:8px;gap:4px}.btn-s svg{width:14px;height:14px}
        .btn-f{width:100%}
        .btn-r{display:flex;gap:6px;flex-wrap:wrap}
        .bg{display:inline-flex;align-items:center;padding:4px 10px;border-radius:50px;font-size:11px;font-weight:700}
        .bg-g{background:#ecfdf5;color:var(--grn)}.bg-a{background:#fffbeb;color:var(--amb)}.bg-r{background:#fef2f2;color:var(--red)}.bg-b{background:rgba(124,58,237,.1);color:var(--b)}.bg-pk{background:#fdf2f8;color:var(--pnk)}
        [data-theme="dark"] .bg-g{background:rgba(5,150,105,.15)}[data-theme="dark"] .bg-a{background:rgba(217,119,6,.15)}[data-theme="dark"] .bg-r{background:rgba(220,38,38,.15)}[data-theme="dark"] .bg-b{background:rgba(124,58,237,.2)}[data-theme="dark"] .bg-pk{background:rgba(236,72,153,.15)}
        .av{display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff;border-radius:12px;flex-shrink:0}
        .st{background:var(--card);border-radius:16px;padding:16px;border:1px solid var(--brd);box-shadow:var(--sh);transition:all .3s}
        .st-ic{width:40px;height:40px;border-radius:12px;display:flex;align-items:center;justify-content:center;margin-bottom:12px}
        .st-ic svg{width:20px;height:20px;flex-shrink:0}
        .st-lb{font-size:11px;color:var(--t3);font-weight:600;margin-bottom:4px}
        .st-vl{font-size:20px;font-weight:800}
        .pipe{display:flex;gap:6px;overflow-x:auto;padding:4px 0;-webkit-overflow-scrolling:touch;scrollbar-width:none}
        .pipe::-webkit-scrollbar{display:none}
        .pipe-i{flex-shrink:0;padding:8px 14px;border-radius:10px;font-size:12px;font-weight:700;cursor:pointer;border:2px solid transparent;transition:all .15s;min-width:70px;text-align:center}
        .pipe-i.on{border-color:var(--b);background:rgba(124,58,237,.08)}
        .pj{background:var(--bg2);border-radius:14px;padding:14px;margin-bottom:10px;transition:background .3s}
        .pj:last-child{margin-bottom:0}
        .pj-gr{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:10px 0}
        .pj-cl{background:var(--card);padding:10px;border-radius:10px;text-align:center;transition:background .3s}
        .pj-cl-l{font-size:9px;color:var(--t3);text-transform:uppercase;font-weight:700;letter-spacing:.3px}
        .pj-cl-v{font-size:14px;font-weight:700;margin-top:2px}
        .mo-bg{position:fixed;inset:0;background:rgba(0,0,0,.5);-webkit-backdrop-filter:blur(4px);backdrop-filter:blur(4px);z-index:1000;display:none;animation:fi .2s}
        .mo-bg.show{display:flex;align-items:flex-end;justify-content:center}
        @keyframes fi{from{opacity:0}to{opacity:1}}
        .mo-sh{background:var(--card);width:100%;max-width:500px;max-height:90vh;overflow-y:auto;-webkit-overflow-scrolling:touch;border-radius:24px 24px 0 0;padding:24px 20px calc(24px + var(--sb));animation:su .3s cubic-bezier(.32,.72,0,1)}
        @keyframes su{from{transform:translateY(100%)}to{transform:translateY(0)}}
        .mo-h{width:36px;height:4px;background:var(--brd2);border-radius:4px;margin:0 auto 16px}
        .mo-t{font-size:20px;font-weight:800;margin-bottom:4px}
        .mo-s{font-size:13px;color:var(--t3);margin-bottom:20px}
        .tst{position:fixed;bottom:calc(var(--nh) + var(--sb) + 16px);left:50%;transform:translateX(-50%);padding:12px 24px;border-radius:14px;font-weight:600;font-size:13px;color:#fff;z-index:10000;animation:tp .3s cubic-bezier(.32,.72,0,1);box-shadow:0 8px 30px rgba(0,0,0,.15);white-space:nowrap;max-width:90vw}
        @keyframes tp{from{opacity:0;transform:translate(-50%,20px) scale(.95)}to{opacity:1;transform:translate(-50%,0) scale(1)}}
        .sy{position:fixed;top:0;left:0;right:0;height:3px;z-index:9999;background:linear-gradient(90deg,var(--b),var(--b2),var(--b));background-size:200% 100%;animation:ss .8s linear infinite}
        @keyframes ss{0%{background-position:200% 0}100%{background-position:-200% 0}}
        .hi{background:var(--bg2);border-radius:10px;padding:10px 12px;margin-top:10px;border-left:3px solid var(--b);transition:background .3s}
        .hi-r{background:var(--bg2);border-radius:10px;padding:10px 12px;margin-top:10px;border-left:3px solid var(--red);transition:background .3s}
        .hi-row{display:flex;align-items:center;justify-content:space-between;padding:6px 0;font-size:12px}
        .hi-row+.hi-row{border-top:1px solid var(--brd)}
        .hi-del{width:24px;height:24px;border-radius:6px;border:none;background:rgba(220,38,38,.1);color:var(--red);display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0}
        .emp{text-align:center;padding:48px 20px}
        .emp-ic{width:64px;height:64px;background:var(--bg2);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 16px}
        .emp-ic svg{width:28px;height:28px;color:var(--t3)}
        .dv-tag{display:inline-flex;align-items:center;gap:4px;padding:5px 10px;background:rgba(124,58,237,.08);border:1px solid rgba(124,58,237,.15);border-radius:8px;font-size:11px;font-weight:600;color:var(--b);margin:3px}
        .theme-sw{position:relative;width:52px;height:28px;border-radius:14px;background:var(--brd2);border:none;cursor:pointer;transition:background .3s;flex-shrink:0}
        .theme-sw::after{content:'';position:absolute;top:3px;left:3px;width:22px;height:22px;border-radius:50%;background:#fff;transition:transform .3s;box-shadow:0 1px 3px rgba(0,0,0,.2)}
        .theme-sw.dark{background:var(--b)}.theme-sw.dark::after{transform:translateX(24px)}
        .theme-ic{position:absolute;top:50%;transform:translateY(-50%);font-size:13px;pointer-events:none}
        .theme-ic.sun{left:6px}.theme-ic.moon{right:6px}
        .pp-box{background:rgba(124,58,237,.05);border:1.5px solid rgba(124,58,237,.15);border-radius:14px;padding:14px;margin-bottom:14px}
        .pp-calc{display:flex;align-items:center;gap:8px;margin-top:8px;padding:10px;background:var(--card);border-radius:10px}
        .pp-calc-v{font-size:18px;font-weight:800;color:var(--b)}
        svg{flex-shrink:0}
        .ic{display:inline-flex;align-items:center;justify-content:center;width:20px;height:20px;flex-shrink:0;vertical-align:middle}
        .ic svg{width:100%;height:100%}
        .ic-s{width:16px;height:16px}.ic-s svg{width:100%;height:100%}
        .ic-xs{width:14px;height:14px}.ic-xs svg{width:100%;height:100%}
        .ic-l{width:22px;height:22px}.ic-l svg{width:100%;height:100%}
        .g2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
        .g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
        .g4{display:grid;grid-template-columns:1fr 1fr;gap:10px}
        .fb{display:flex;align-items:center;justify-content:space-between}
        .fc{display:flex;align-items:center}.f1{flex:1;min-width:0}
        .trn{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .tc{color:var(--b)}.tg{color:var(--grn)}.tr{color:var(--red)}.tm{color:var(--t2)}.tl{color:var(--t3)}
        .ts{font-size:11px}.tsm{font-size:13px}.tlg{font-size:18px}
        .fb7{font-weight:700}.fb8{font-weight:800}
        .mb4{margin-bottom:4px}.mb8{margin-bottom:8px}.mb12{margin-bottom:12px}.mb16{margin-bottom:16px}
        .mt8{margin-top:8px}.srch-wrap{flex-shrink:0;padding:12px 16px}
        .s-brief{background:#eff6ff;color:#2563eb}.s-design{background:#f5f0ff;color:#7c3aed}.s-review{background:#fffbeb;color:#d97706}.s-revision{background:#fdf2f8;color:#ec4899}.s-approved{background:#ecfdf5;color:#059669}.s-delivered{background:#f0fdf4;color:#16a34a}.s-cancelled{background:#fef2f2;color:#dc2626}
        [data-theme="dark"] .s-brief{background:rgba(37,99,235,.15)}[data-theme="dark"] .s-design{background:rgba(124,58,237,.15)}[data-theme="dark"] .s-review{background:rgba(217,119,6,.15)}[data-theme="dark"] .s-revision{background:rgba(236,72,153,.15)}[data-theme="dark"] .s-approved{background:rgba(5,150,105,.15)}[data-theme="dark"] .s-delivered{background:rgba(22,163,74,.15)}[data-theme="dark"] .s-cancelled{background:rgba(220,38,38,.15)}
        @media(min-width:768px){:root{--nh:0px}body{overflow:hidden}#app{flex-direction:row;height:100vh}.side{width:260px;height:100vh;background:var(--card);border-right:1px solid var(--brd);flex-shrink:0;display:flex;flex-direction:column;padding:28px 16px;overflow-y:auto;transition:background .3s}.side-logo{display:flex;align-items:center;gap:12px;margin-bottom:32px;padding:0 8px}.side-li{width:44px;height:44px;background:linear-gradient(135deg,var(--b),var(--b2));border-radius:14px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:18px;flex-shrink:0;overflow:hidden}.side-li img{width:100%;height:100%;object-fit:cover}.side-bn{font-weight:800;font-size:15px}.side-sb{font-size:11px;color:var(--t3)}.side-nv{flex:1}.side-bt{display:flex;align-items:center;gap:12px;width:100%;padding:12px 14px;border-radius:12px;border:none;background:none;color:var(--t2);font-weight:500;font-size:14px;cursor:pointer;transition:all .15s;font-family:inherit;margin-bottom:2px;text-align:left}.side-bt:hover{background:var(--bg2);color:var(--text)}.side-bt.on{background:rgba(124,58,237,.08);color:var(--b)}.side-bt svg{width:20px;height:20px;flex-shrink:0}.side-ft{border-top:1px solid var(--brd);padding-top:16px;margin-top:16px}.app-bd{flex:1;display:flex;flex-direction:column;overflow:hidden;min-height:0}.nav{display:none!important}.hdr{padding-left:24px;padding-right:24px;height:68px;min-height:68px}.main-in{padding:24px;padding-bottom:24px;max-width:900px}.st-vl{font-size:24px}.g4{grid-template-columns:repeat(4,1fr)}.mo-bg.show{align-items:center}.mo-sh{border-radius:24px;max-width:540px;padding-bottom:24px}.mob{display:none!important}.dsk{display:flex!important}}
        @media(max-width:767px){.side{display:none!important}.dsk{display:none!important}.mob{display:flex!important}.app-bd{flex:1;display:flex;flex-direction:column;overflow:hidden;min-height:0;height:100%}.main{flex:1;overflow-y:auto!important;overflow-x:hidden;-webkit-overflow-scrolling:touch;min-height:0!important;height:0}}
        @media(max-width:360px){.st-vl{font-size:16px}.main-in{padding:12px;padding-bottom:calc(var(--nh) + var(--sb) + 30px)}}
    </style>
</head>
<body>
<div id="splash"><div class="slogo">N</div><div style="font-weight:800;font-size:18px;">NIDHS DESIGN</div><div style="font-size:12px;color:var(--t3);margin-top:4px;" id="splashText">Loading studio...</div><div class="sbar"><div class="sbar-in"></div></div></div>
<div id="setup"><div class="setup-in"><div class="setup-box"><div style="text-align:center;margin-bottom:28px;"><div class="slogo" style="margin:0 auto 16px;animation:none;">N</div><div style="font-weight:800;font-size:22px;">NIDHS DESIGN CRM</div><div style="font-size:13px;color:var(--t3);margin-top:4px;">Connect GitHub to start</div></div><div class="fld"><label class="fld-l">GitHub Username</label><input type="text" id="ghU" class="fld-i" placeholder="your-username" autocomplete="off"></div><div class="fld"><label class="fld-l">Repository Name</label><input type="text" id="ghR" class="fld-i" placeholder="my-crm-data" autocomplete="off"></div><div class="fld"><label class="fld-l">Personal Access Token</label><input type="password" id="ghT" class="fld-i" placeholder="ghp_xxxx" autocomplete="off"><div style="font-size:11px;color:var(--t3);margin-top:6px;"><a href="https://github.com/settings/tokens/new?scopes=repo" target="_blank" style="color:var(--b);font-weight:600;text-decoration:none;">Create token ‚Üí</a></div></div><button onclick="testGH()" class="btn btn-g btn-f mb12">Test Connection</button><div id="tR" style="display:none;padding:12px;border-radius:10px;font-size:13px;font-weight:600;text-align:center;margin-bottom:12px;"></div><button onclick="conGH()" class="btn btn-b btn-f" id="conBtn">Launch Studio</button></div></div></div>
<div id="syB" class="sy" style="display:none;"></div>
<div id="app"><div class="side" id="sidebar"></div><div class="app-bd"><div class="hdr" id="hdrBar"></div><div class="mob srch-wrap" id="srchB" style="display:none;"></div><div class="main" id="mainS"><div class="main-in" id="cnt"></div></div></div><nav class="nav" id="navBar"></nav></div>
<div id="mo" class="mo-bg" onclick="if(event.target===this)cMo()"><div class="mo-sh" id="moC" onclick="event.stopPropagation()"></div></div>

<script>
const BN='NIDHS DESIGN',FL='nidhs_design_crm.json';
const PT=['Logo Design','Brand Identity','Social Media Kit','Social Media Posts','Packaging Design','Print Design','UI/UX Design','Illustration','Motion Graphics','Photo Editing','Presentation','Infographic','Banner/Ad','Poster','Flyer/Brochure','Other'];
const PS=['Brief','Design','Review','Revision','Approved','Delivered','Cancelled'];
const PM=['UPI','Cash','Bank Transfer','Cheque','Credit Card','Other'];
const DL=['Logo Files (AI/EPS/SVG/PNG)','Brand Guidelines PDF','Social Media Templates','Business Card','Letterhead','Packaging Mockups','Website Mockups','App Screens','Print-Ready Files','Source Files','Presentation','Video/Animation','Photo Edits','Post Designs','Story Designs','Reel Covers','Raw Files','Other'];
const PRICING=['Fixed','Per Post','Per Page','Per Hour'];
const SC={Brief:'s-brief',Design:'s-design',Review:'s-review',Revision:'s-revision',Approved:'s-approved',Delivered:'s-delivered',Cancelled:'s-cancelled'};
function ic(s,z){return'<span class="ic'+(z?' ic-'+z:'')+'">' + s + '</span>'}
function ci(s,c){return s.replace(/currentColor/g,c)}
const _={grid:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>',users:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>',plus:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>',set:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>',ref:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>',x:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>',chk:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>',up:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>',dn:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 17 13.5 8.5 8.5 13.5 2 7"/><polyline points="16 17 22 17 22 11"/></svg>',clk:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',wal:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></svg>',src:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>',edt:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></svg>',del:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>',msg:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"/></svg>',fl:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/></svg>',dwn:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>',upl:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>',sav:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"/><path d="M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7"/><path d="M7 3v4a1 1 0 0 0 1 1h7"/></svg>',cld:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z"/></svg>',out:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>',wrn:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>',pal:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="13.5" cy="6.5" r=".5" fill="currentColor"/><circle cx="17.5" cy="10.5" r=".5" fill="currentColor"/><circle cx="8.5" cy="7.5" r=".5" fill="currentColor"/><circle cx="6.5" cy="12.5" r=".5" fill="currentColor"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"/></svg>',db:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M3 5V19A9 3 0 0 0 21 19V5"/><path d="M3 12A9 3 0 0 0 21 12"/></svg>',cal:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/></svg>',lay:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83Z"/><path d="m22 17.65-9.17 4.16a2 2 0 0 1-1.66 0L2 17.65"/><path d="m22 12.65-9.17 4.16a2 2 0 0 1-1.66 0L2 12.65"/></svg>',rev:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></svg>',pkg:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m7.5 4.27 9 5.15"/><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></svg>',flg:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" y1="22" x2="4" y2="15"/></svg>',sun:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41"/></svg>',moon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>',hash:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="4" y1="9" x2="20" y2="9"/><line x1="4" y1="15" x2="20" y2="15"/><line x1="10" y1="3" x2="8" y2="21"/><line x1="16" y1="3" x2="14" y2="21"/></svg>',inv:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M7 15h0M2 9.5h20"/></svg>'};

let D={brand:{name:BN,logo:null},clients:[],theme:'light'};
let gh=null,sha=null,pg='dash',sq='',sf='all';
const $=id=>document.getElementById(id);
const inr=n=>'‚Çπ'+(n||0).toLocaleString('en-IN');
const td=()=>new Date().toISOString().split('T')[0];
const fmtD=d=>{if(!d)return'';try{return new Date(d).toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'})}catch(e){return d}};
const pdd=p=>(p.payments||[]).reduce((a,v)=>a+(v.amount||0),0);
const gB=p=>{if(p.pricing&&p.pricing!=='Fixed')return(p.pricePerUnit||0)*(p.quantity||0);return p.budget||0};
const pn=p=>gB(p)-pdd(p);
const ex=p=>(p.expenses||[]).reduce((a,e)=>a+(e.amount||0),0);
const opts=(a,s)=>a.map(v=>`<option value="${v}"${v===s?' selected':''}>${v}</option>`).join('');
function bLbl(p){if(p.pricing==='Per Post')return inr(p.pricePerUnit)+' √ó '+p.quantity+' posts';if(p.pricing==='Per Page')return inr(p.pricePerUnit)+' √ó '+p.quantity+' pages';if(p.pricing==='Per Hour')return inr(p.pricePerUnit)+' √ó '+p.quantity+' hrs';return''}
function tst(m,ok=1){const t=document.createElement('div');t.className='tst';t.style.background=ok?'linear-gradient(135deg,#059669,#10b981)':'linear-gradient(135deg,#dc2626,#ef4444)';t.textContent=m;document.body.appendChild(t);setTimeout(()=>t.remove(),2500)}
function dL(d){if(!d)return null;return Math.ceil((new Date(d)-new Date())/(864e5))}
function dC(d){const l=dL(d);if(l==null)return'tl';return l<0?'tr':l<=3?'tr':l<=7?'tc':'tg'}
function dT(d){const l=dL(d);if(l==null)return'No deadline';if(l<0)return Math.abs(l)+'d overdue';if(!l)return'Due today';return l+'d left'}
function fixD(){if(!D.brand)D.brand={name:BN,logo:null};if(!D.clients)D.clients=[];if(!D.theme)D.theme='light'}
function initTheme(){const s=D.theme||localStorage.getItem('nd_theme');if(s==='dark'||(s!=='light'&&matchMedia('(prefers-color-scheme:dark)').matches)){document.documentElement.setAttribute('data-theme','dark');D.theme='dark'}else{document.documentElement.removeAttribute('data-theme');D.theme='light'}}
function togTheme(){D.theme=D.theme==='dark'?'light':'dark';D.theme==='dark'?document.documentElement.setAttribute('data-theme','dark'):document.documentElement.removeAttribute('data-theme');localStorage.setItem('nd_theme',D.theme);render();sav()}

function buildSide(){const n=D.brand?.name||BN,l=D.brand?.logo,dk=D.theme==='dark';$('sidebar').innerHTML=`<div class="side-logo"><div class="side-li">${l?'<img src="'+l+'"alt="">':n.charAt(0)}</div><div><div class="side-bn">${n}</div><div class="side-sb">Design Studio CRM</div></div></div><nav class="side-nv"><button onclick="go('dash')" class="side-bt ${pg==='dash'?'on':''}">${ic(_.grid)} Dashboard</button><button onclick="go('clients')" class="side-bt ${pg==='clients'?'on':''}">${ic(_.users)} Clients</button><button onclick="go('projects')" class="side-bt ${pg==='projects'?'on':''}">${ic(_.lay)} Projects</button><button onclick="go('settings')" class="side-bt ${pg==='settings'?'on':''}">${ic(_.set)} Settings</button></nav><div class="side-ft"><div class="fb mb12" style="padding:0 8px;"><span class="tsm tm">${dk?'Dark':'Light'}</span><button class="theme-sw ${dk?'dark':''}" onclick="togTheme()"><span class="theme-ic sun">‚òÄÔ∏è</span><span class="theme-ic moon">üåô</span></button></div><button onclick="syn()" class="btn btn-o btn-f mb8">${ic(_.ref,'s')} Sync</button><div class="fc" style="gap:8px;padding:0 8px;"><div style="width:8px;height:8px;border-radius:50%;background:var(--grn);flex-shrink:0;"></div><span class="ts tm" id="syS">Connected</span></div></div>`}
function buildHdr(){const n=D.brand?.name||BN,l=D.brand?.logo,dk=D.theme==='dark',t={dash:'Dashboard',clients:'Clients',projects:'Projects',settings:'Settings'}[pg]||'Dashboard';$('hdrBar').innerHTML=`<div class="hdr-logo mob">${l?'<img src="'+l+'"alt="">':n.charAt(0)}</div><div class="f1 trn"><span class="hdr-t">${t}</span></div><button onclick="togTheme()" class="hdr-btn mob">${dk?ic(_.sun):ic(_.moon)}</button><button onclick="syn()" class="hdr-btn mob">${ic(_.ref)}</button><button onclick="oClient()" class="btn btn-b btn-s dsk">${ic(_.plus,'xs')} New Client</button><button onclick="togTheme()" class="hdr-btn dsk">${dk?ic(_.sun):ic(_.moon)}</button>`}
function buildSrch(){const s=$('srchB');s.style.display=(pg==='clients'||pg==='projects')?'block':'none';s.innerHTML=`<div style="position:relative;"><span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);">${ic(_.src,'s')}</span><input type="text" oninput="doSrch(this.value)" placeholder="Search..." class="fld-i" style="padding-left:38px;" value="${sq}"></div>`}
function buildNav(){$('navBar').innerHTML=`<button onclick="go('dash')" class="nav-b ${pg==='dash'?'on':''}">${ic(_.grid,'l')}<span>Home</span></button><button onclick="go('clients')" class="nav-b ${pg==='clients'?'on':''}">${ic(_.users,'l')}<span>Clients</span></button><button onclick="oClient()" class="nav-fab">${ic(_.plus,'l')}</button><button onclick="go('projects')" class="nav-b ${pg==='projects'?'on':''}">${ic(_.lay,'l')}<span>Projects</span></button><button onclick="go('settings')" class="nav-b ${pg==='settings'?'on':''}">${ic(_.set,'l')}<span>Settings</span></button>`}

async function testGH(){const u=$('ghU').value.trim(),r=$('ghR').value.trim(),t=$('ghT').value.trim(),rs=$('tR');rs.style.display='block';if(!u||!r||!t){rs.style.background='#fef2f2';rs.style.color='#dc2626';rs.textContent='‚ùå Fill all';return}rs.style.background='#fffbeb';rs.style.color='#92400e';rs.textContent='Testing...';try{let x=await fetch('https://api.github.com/user',{headers:{Authorization:'token '+t}});if(!x.ok)throw'Bad token';x=await fetch(`https://api.github.com/repos/${u}/${r}`,{headers:{Authorization:'token '+t}});if(!x.ok)throw'Repo not found';rs.style.background='#ecfdf5';rs.style.color='#059669';rs.textContent='‚úÖ Connected!'}catch(e){rs.style.background='#fef2f2';rs.style.color='#dc2626';rs.textContent='‚ùå '+e}}
async function pull(){if(!gh)return null;try{const r=await fetch(`https://api.github.com/repos/${gh.u}/${gh.r}/contents/${FL}`,{headers:{Authorization:'token '+gh.t},cache:'no-store'});if(r.status===200){const j=await r.json();sha=j.sha;return JSON.parse(decodeURIComponent(escape(atob(j.content))))}}catch(e){console.error(e)}return null}
async function push(){if(!gh)return!1;try{const b={message:BN+' '+new Date().toLocaleString(),content:btoa(unescape(encodeURIComponent(JSON.stringify(D,null,2))))};if(sha)b.sha=sha;const r=await fetch(`https://api.github.com/repos/${gh.u}/${gh.r}/contents/${FL}`,{method:'PUT',headers:{Authorization:'token '+gh.t,'Content-Type':'application/json'},body:JSON.stringify(b)});if(r.ok){sha=(await r.json()).content.sha;return!0}}catch(e){console.error(e)}return!1}
async function syn(){$('syB').style.display='block';const d=await pull();if(d){D=d;fixD();localStorage.setItem('nd',JSON.stringify(D));initTheme();render();tst('Synced!')}$('syB').style.display='none';const s=$('syS');if(s)s.textContent='Synced'}
async function sav(){localStorage.setItem('nd',JSON.stringify(D));$('syB').style.display='block';const ok=await push();$('syB').style.display='none';tst(ok?'Saved!':'Failed',ok)}
async function conGH(){const u=$('ghU').value.trim(),r=$('ghR').value.trim(),t=$('ghT').value.trim();if(!u||!r||!t){tst('Fill all',0);return}$('conBtn').textContent='Connecting...';$('conBtn').disabled=!0;gh={u,r,t};localStorage.setItem('ndgh',JSON.stringify(gh));const d=await pull();if(d){D=d;fixD()}else await push();localStorage.setItem('nd',JSON.stringify(D));$('setup').style.display='none';$('app').classList.add('show');initTheme();go('dash');tst('Welcome to '+BN+'!')}
async function init(){try{const s=localStorage.getItem('ndgh');if(s)gh=JSON.parse(s);const c=localStorage.getItem('nd');if(c){D=JSON.parse(c);fixD()}}catch(e){}initTheme();if(!gh){$('splash').classList.add('hide');$('setup').style.display='block';return}$('splashText').textContent='Loading '+BN+'...';try{const d=await pull();if(d){D=d;fixD();localStorage.setItem('nd',JSON.stringify(D));initTheme()}}catch(e){}$('splash').classList.add('hide');$('app').classList.add('show');go('dash');setInterval(()=>{if(gh)syn()},12e4);document.addEventListener('visibilitychange',()=>{if(!document.hidden&&gh)syn()})}

function go(p){pg=p;sq='';sf='all';$('mainS').scrollTop=0;render()}
function doSrch(v){sq=v.toLowerCase();rContent()}
function render(){buildSide();buildHdr();buildSrch();buildNav();rContent()}
function rContent(){const c=$('cnt');if(pg==='dash')rDash(c);else if(pg==='clients')rCl(c);else if(pg==='projects')rPjV(c);else if(pg==='settings')rSt(c)}
function allP(){const r=[];(D.clients||[]).forEach(c=>(c.projects||[]).forEach(p=>r.push({...p,cn:c.name,ci:c.id,cp:c.phone})));return r}

function rDash(el){const pjs=allP();let col=0,pen=0,exp=0;pjs.forEach(p=>{col+=pdd(p);pen+=pn(p);exp+=ex(p)});const pr=col-exp,ac=pjs.filter(p=>!['Delivered','Cancelled'].includes(p.status)),ov=ac.filter(p=>dL(p.deadline)<0),bs={};PS.forEach(s=>{bs[s]=pjs.filter(p=>p.status===s).length});
el.innerHTML=`<div class="g4 mb16"><div class="st"><div class="st-ic" style="background:rgba(5,150,105,.1);">${ic(ci(_.up,'#059669'))}</div><div class="st-lb">Collected</div><div class="st-vl tg">${inr(col)}</div></div><div class="st"><div class="st-ic" style="background:rgba(217,119,6,.1);">${ic(ci(_.clk,'#d97706'))}</div><div class="st-lb">Pending</div><div class="st-vl" style="color:var(--amb);">${inr(pen)}</div></div><div class="st"><div class="st-ic" style="background:rgba(220,38,38,.1);">${ic(ci(_.dn,'#dc2626'))}</div><div class="st-lb">Expenses</div><div class="st-vl tr">${inr(exp)}</div></div><div class="st"><div class="st-ic" style="background:rgba(124,58,237,.1);">${ic(ci(_.wal,'#7c3aed'))}</div><div class="st-lb">Profit</div><div class="st-vl tc">${inr(pr)}</div></div></div>
<div class="g2 mb16"><div class="cd cd-p" style="background:linear-gradient(135deg,var(--b),var(--b2));color:#fff;"><div class="fc" style="gap:8px;margin-bottom:8px;opacity:.8;">${ic(_.lay,'s')}<span class="tsm">Active</span></div><div class="st-vl">${ac.length}</div>${ov.length?'<div class="ts mt8" style="opacity:.9;">‚ö†Ô∏è '+ov.length+' overdue</div>':''}</div><div class="cd cd-p"><div class="fc" style="gap:8px;margin-bottom:8px;color:var(--t3);">${ic(_.rev,'s')}<span class="tsm">Revisions</span></div><div class="st-vl">${pjs.reduce((a,p)=>a+(p.revisions||0),0)}</div><div class="ts tl mt8">${D.clients?.length||0} clients</div></div></div>
<div class="cd cd-p mb12"><div class="fb7 mb12">Pipeline</div><div class="g3">${PS.filter(s=>s!=='Cancelled').map(s=>`<div style="text-align:center;padding:10px;background:var(--bg2);border-radius:10px;"><div class="bg ${SC[s]}" style="margin-bottom:6px;font-size:10px;">${s}</div><div class="fb8 tlg">${bs[s]||0}</div></div>`).join('')}</div></div>
${ov.length?`<div class="cd cd-p mb12" style="border-left:3px solid var(--red);"><div class="fb7 tr mb12">‚ö†Ô∏è Overdue</div>${ov.map(p=>`<div style="display:flex;align-items:center;justify-content:space-between;padding:10px;background:rgba(220,38,38,.06);border-radius:10px;margin-bottom:6px;"><div><div class="fb7">${p.name}</div><div class="ts tm">${p.cn} ‚Ä¢ ${Math.abs(dL(p.deadline))}d overdue</div></div><span class="bg bg-r">${p.status}</span></div>`).join('')}</div>`:''}
<div class="cd cd-p"><div class="fb7 mb12">Quick Actions</div><div class="g2"><button onclick="oClient()" class="btn btn-o btn-f" style="justify-content:flex-start;">${ic(_.plus,'s')} New Client</button><button onclick="go('projects')" class="btn btn-o btn-f" style="justify-content:flex-start;">${ic(_.lay,'s')} Projects</button><button onclick="syn()" class="btn btn-o btn-f" style="justify-content:flex-start;">${ic(_.ref,'s')} Sync</button><button onclick="go('clients')" class="btn btn-o btn-f" style="justify-content:flex-start;">${ic(_.users,'s')} Clients</button></div></div>`}

function rCl(el){const all=D.clients||[],f=all.filter(c=>c.name.toLowerCase().includes(sq)||(c.projects||[]).some(p=>p.name.toLowerCase().includes(sq)));if(!f.length){el.innerHTML=`<div class="cd emp"><div class="emp-ic">${ic(_.users)}</div><div class="fb7 tlg mb8">${all.length?'No matches':'No clients'}</div><button onclick="oClient()" class="btn btn-b mt8">${ic(_.plus,'xs')} Add Client</button></div>`;return}
el.innerHTML=f.map(c=>{const pjs=c.projects||[],tv=pjs.reduce((a,p)=>a+gB(p),0),tp=pjs.reduce((a,p)=>a+pdd(p),0),tpn=tv-tp,ac=pjs.filter(p=>!['Delivered','Cancelled'].includes(p.status)).length;
return`<div class="cd"><div class="cd-p" style="border-bottom:1px solid var(--brd);"><div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;"><div class="av" style="width:48px;height:48px;font-size:18px;background:linear-gradient(135deg,var(--b),var(--b2));">${c.name.charAt(0)}</div><div class="f1" style="min-width:0;"><div class="fb7 tlg trn">${c.name}</div><div class="ts tm trn">${c.contact||''} ${c.phone?'‚Ä¢ +'+c.phone:''}</div></div></div><div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px;"><span class="bg bg-b">${pjs.length} projects</span>${ac?'<span class="bg bg-a">'+ac+' active</span>':''}<span class="bg bg-g">Paid: ${inr(tp)}</span>${tpn>0?'<span class="bg bg-r">Due: '+inr(tpn)+'</span>':''}</div><div class="btn-r"><button onclick="oPjM(${c.id})" class="btn btn-b btn-s">${ic(_.plus,'xs')} Project</button><button onclick="wa(${c.id})" class="btn btn-gn btn-s">${ic(_.msg,'xs')} WhatsApp</button><button onclick="gInv(${c.id})" class="btn btn-g btn-s">${ic(_.inv,'xs')} Invoice</button><button onclick="eClient(${c.id})" class="btn btn-g btn-s">${ic(_.edt,'xs')} Edit</button><button onclick="dClient(${c.id})" class="btn btn-rd btn-s">${ic(_.del,'xs')}</button></div></div><div class="cd-p">${pjs.map(p=>rPC(c,p)).join('')}${!pjs.length?'<div class="ts tl" style="text-align:center;padding:20px;">No projects</div>':''}</div></div>`}).join('')}

function rPC(c,p){const b=gB(p),sp=pdd(p),spn=b-sp,se=ex(p),spr=sp-se,dn=p.status==='Delivered';
return`<div class="pj"><div class="fb mb8"><div style="flex:1;min-width:0;"><div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;"><span class="fb7">${p.name}</span><span class="bg ${SC[p.status]||'bg-b'}" style="font-size:10px;">${p.status}</span>${p.portfolio?'<span class="bg bg-pk" style="font-size:9px;">‚òÖ Portfolio</span>':''}</div><div class="ts tl mt8">${p.type||'Design'} ‚Ä¢ ${p.pricing||'Fixed'} ‚Ä¢ Rev: ${p.revisions||0}/${p.maxRevisions||3}</div>${p.pricing&&p.pricing!=='Fixed'?`<div class="ts tc mt8">${ic(_.hash,'xs')} ${bLbl(p)} = ${inr(b)}</div>`:''}${p.deadline?`<div class="ts ${dC(p.deadline)} mt8">${ic(_.cal,'xs')} ${dT(p.deadline)}</div>`:''}</div></div>
<div class="btn-r mb8"><button onclick="oStat(${c.id},${p.id})" class="btn btn-o btn-s">${ic(_.flg,'xs')} Status</button><button onclick="ePjM(${c.id},${p.id})" class="btn btn-g btn-s">${ic(_.edt,'xs')} Edit</button>${!dn?`<button onclick="oPay(${c.id},${p.id})" class="btn btn-b btn-s">+ Pay</button>`:''}<button onclick="oExpP(${c.id},${p.id})" class="btn btn-rd btn-s">+ Exp</button><button onclick="oDlv(${c.id},${p.id})" class="btn btn-g btn-s">${ic(_.pkg,'xs')} Files</button><button onclick="gPjInv(${c.id},${p.id})" class="btn btn-g btn-s">${ic(_.dwn,'xs')}</button></div>
<div class="pj-gr"><div class="pj-cl"><div class="pj-cl-l">Budget</div><div class="pj-cl-v">${inr(b)}</div></div><div class="pj-cl"><div class="pj-cl-l">Received</div><div class="pj-cl-v tg">${inr(sp)}</div></div><div class="pj-cl"><div class="pj-cl-l">Expenses</div><div class="pj-cl-v tr">${inr(se)}</div></div><div class="pj-cl"><div class="pj-cl-l">Profit</div><div class="pj-cl-v tc">${inr(spr)}</div></div></div>
${(p.deliverables||[]).length?`<div style="margin-top:8px;">${p.deliverables.map(d=>`<span class="dv-tag">${ic(_.fl,'xs')} ${d}</span>`).join('')}</div>`:''}
${p.notes?`<div class="hi mt8"><div class="ts tm">${p.notes}</div></div>`:''}
${(p.payments||[]).length?`<div class="hi mt8"><div class="ts fb7 tm mb8">üí∞ Payments</div>${p.payments.map((v,i)=>`<div class="hi-row"><span class="tm f1" style="min-width:0;"><b class="${i===0?'tc':'tg'}">${i===0?'Advance':'Payment '+(i+1)}</b>: ${inr(v.amount)} ‚Ä¢ <b>${fmtD(v.date)}</b> ‚Ä¢ ${v.mode}</span><button class="hi-del" onclick="dPay(${c.id},${p.id},${v.id})">${ic(_.x,'xs')}</button></div>`).join('')}</div>`:''}
${(p.expenses||[]).length?`<div class="hi-r mt8"><div class="ts fb7 tr mb8">üìã Expenses (Internal Only)</div>${p.expenses.map(e=>`<div class="hi-row"><span class="tm f1" style="min-width:0;">${e.desc}: ${inr(e.amount)} ‚Ä¢ ${fmtD(e.date)}</span><button class="hi-del" onclick="dExp(${c.id},${p.id},${e.id})">${ic(_.x,'xs')}</button></div>`).join('')}</div>`:''}
</div>`}

function rPjV(el){const pjs=allP(),f=pjs.filter(p=>(sf==='all'||p.status===sf)&&(p.name.toLowerCase().includes(sq)||p.cn.toLowerCase().includes(sq)));
el.innerHTML=`<div class="pipe mb16">${['all',...PS].map(s=>`<div class="pipe-i ${sf===s?'on':''} ${s!=='all'?(SC[s]||''):'bg-b'}" onclick="sf='${s}';rContent()">${s==='all'?'All ('+pjs.length+')':s+' ('+pjs.filter(p=>p.status===s).length+')'}</div>`).join('')}</div>${!f.length?`<div class="cd emp"><div class="emp-ic">${ic(_.lay)}</div><div class="fb7 tlg mb8">No projects</div></div>`:f.map(p=>{const c=D.clients.find(x=>x.id===p.ci);return c?`<div class="cd"><div class="cd-p"><div class="ts tl mb4">${p.cn}</div>${rPC(c,p)}</div></div>`:''}).join('')}`}

function rSt(el){const n=D.brand?.name||BN,l=D.brand?.logo,dk=D.theme==='dark';
el.innerHTML=`<div style="max-width:480px;margin:0 auto;"><div class="cd cd-p mb12"><div class="fb mb16"><span class="fb7" style="display:flex;align-items:center;gap:8px;">${dk?ic(_.moon,'s'):ic(_.sun,'s')} Appearance</span><button class="theme-sw ${dk?'dark':''}" onclick="togTheme()"><span class="theme-ic sun">‚òÄÔ∏è</span><span class="theme-ic moon">üåô</span></button></div><div class="tsm tm">${dk?'Dark':'Light'} mode</div></div><div class="cd cd-p mb12"><div class="fb7 mb16" style="display:flex;align-items:center;gap:8px;">${ic(_.pal,'s')} Studio</div><div class="fld"><label class="fld-l">Studio Name</label><input type="text" id="bN" value="${n}" class="fld-i"></div><div class="fld"><label class="fld-l">Logo</label><div style="display:flex;align-items:center;gap:12px;"><div class="slogo" style="animation:none;width:56px;height:56px;font-size:22px;border-radius:16px;">${l?'<img src="'+l+'"alt="">':n.charAt(0)}</div><div class="f1"><input type="file" id="lF" accept="image/*" onchange="uLogo(this)" style="display:none;"><button onclick="document.getElementById('lF').click()" class="btn btn-g btn-s btn-f mb8">${ic(_.upl,'xs')} Upload</button>${l?'<button onclick="rLogo()" class="btn btn-rd btn-s btn-f">Remove</button>':''}</div></div></div><button onclick="sBrd()" class="btn btn-b btn-f">${ic(_.sav,'s')} Save</button></div><div class="cd cd-p mb12"><div class="fb7 mb16" style="display:flex;align-items:center;gap:8px;">${ic(_.cld,'s')} Sync</div><div style="display:flex;align-items:center;gap:8px;padding:12px;background:rgba(5,150,105,.08);border-radius:12px;margin-bottom:12px;"><div style="width:8px;height:8px;border-radius:50%;background:var(--grn);"></div><span class="tsm tg fb7">${gh?.u||''}/${gh?.r||''}</span></div><button onclick="syn()" class="btn btn-g btn-f">${ic(_.ref,'s')} Force Sync</button></div><div class="cd cd-p mb12"><div class="fb7 mb16" style="display:flex;align-items:center;gap:8px;">${ic(_.db,'s')} Data</div><div class="g2"><button onclick="expD()" class="btn btn-g">${ic(_.dwn,'xs')} Export</button><input type="file" id="iF" accept=".json" onchange="impD(this)" style="display:none;"><button onclick="document.getElementById('iF').click()" class="btn btn-g">${ic(_.upl,'xs')} Import</button></div></div><div class="cd cd-p" style="border:2px solid rgba(220,38,38,.3);"><div class="fb7 tr mb16">${ic(_.wrn,'s')} Danger</div><button onclick="disc()" class="btn btn-rd btn-f">${ic(_.out,'s')} Disconnect</button></div></div>`}

function uLogo(i){const f=i.files[0];if(!f)return;const r=new FileReader();r.onload=e=>{D.brand=D.brand||{};D.brand.logo=e.target.result;render();tst('Uploaded')};r.readAsDataURL(f)}
function rLogo(){D.brand.logo=null;render();tst('Removed')}
async function sBrd(){D.brand=D.brand||{};D.brand.name=$('bN').value.trim()||BN;await sav();render()}
function expD(){const b=new Blob([JSON.stringify(D,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=BN.replace(/ /g,'_')+'_'+td()+'.json';a.click();tst('Exported!')}
async function impD(i){const f=i.files[0];if(!f)return;const r=new FileReader();r.onload=async e=>{try{const d=JSON.parse(e.target.result);if(d.clients)D.clients=d.clients;if(d.brand)D.brand=d.brand;await sav();render();tst('Imported!')}catch(err){tst('Invalid',0)}};r.readAsText(f);i.value=''}
function disc(){if(!confirm('Disconnect?'))return;localStorage.removeItem('ndgh');location.reload()}

function cMo(){$('mo').classList.remove('show')}
function sMo(h){$('moC').innerHTML='<div class="mo-h"></div>'+h;$('mo').classList.add('show')}

// CLIENT
function oClient(c){c=c||null;sMo(`<div class="mo-t">${c?'Edit':'New'} Client</div><div class="mo-s">${c?'Update':'Add to studio'}</div><input type="hidden" id="cId" value="${c?.id||''}"><div class="g2 mb12"><div class="fld"><label class="fld-l">Name *</label><input type="text" id="cN" value="${c?.name||''}" class="fld-i" placeholder="Client"></div><div class="fld"><label class="fld-l">Contact</label><input type="text" id="cC" value="${c?.contact||''}" class="fld-i" placeholder="Person"></div></div><div class="g2 mb12"><div class="fld"><label class="fld-l">Phone</label><input type="text" id="cP" value="${c?.phone||'91'}" class="fld-i" placeholder="91XXXXXXXXXX"></div><div class="fld"><label class="fld-l">Email</label><input type="email" id="cE" value="${c?.email||''}" class="fld-i" placeholder="email@co.com"></div></div><div class="fld"><label class="fld-l">Source</label><input type="text" id="cS" value="${c?.source||''}" class="fld-i" placeholder="Instagram, referral..."></div><button onclick="svCl()" class="btn btn-b btn-f">${ic(_.chk,'s')} ${c?'Update':'Add'}</button>`)}
async function svCl(){const n=$('cN').value.trim();if(!n){tst('Enter name',0);return}const id=$('cId').value;if(id){const i=D.clients.findIndex(x=>x.id===parseInt(id));if(i>=0)Object.assign(D.clients[i],{name:n,contact:$('cC').value.trim(),phone:$('cP').value.trim(),email:$('cE').value.trim(),source:$('cS').value.trim()})}else D.clients.push({id:Date.now(),name:n,contact:$('cC').value.trim(),phone:$('cP').value.trim(),email:$('cE').value.trim(),source:$('cS').value.trim(),projects:[]});cMo();await sav();render()}
function eClient(id){oClient(D.clients.find(c=>c.id===id))}
async function dClient(id){if(!confirm('Delete client & projects?'))return;D.clients=D.clients.filter(c=>c.id!==id);await sav();render()}

// PROJECT
function oPjM(ci,p){p=p||null;const c=D.clients.find(x=>x.id===ci);if(!c)return;const isU=p&&p.pricing&&p.pricing!=='Fixed';
sMo(`<div class="mo-t">${p?'Edit':'New'} Project</div><div class="mo-s">${c.name}</div><input type="hidden" id="pC" value="${ci}"><input type="hidden" id="pI" value="${p?.id||''}"><div class="fld"><label class="fld-l">Project Name *</label><input type="text" id="pN" value="${p?.name||''}" class="fld-i" placeholder="Logo, 30 Posts..."></div><div class="g2 mb12"><div class="fld"><label class="fld-l">Type</label><select id="pT" class="fld-i">${opts(PT,p?.type)}</select></div><div class="fld"><label class="fld-l">Status</label><select id="pS" class="fld-i">${opts(PS,p?.status||'Brief')}</select></div></div><div class="fld"><label class="fld-l">Pricing</label><select id="pPr" class="fld-i" onchange="togPr()">${opts(PRICING,p?.pricing||'Fixed')}</select></div><div id="fxB" style="${isU?'display:none':''}"><div class="fld"><label class="fld-l">Budget ‚Çπ *</label><input type="number" id="pB" value="${p?.budget||''}" class="fld-i" placeholder="0"></div></div><div id="unB" style="${isU?'':'display:none'}"><div class="pp-box"><div class="fb7 mb8">${ic(_.hash,'xs')} Unit Pricing</div><div class="g2 mb8"><div class="fld" style="margin:0"><label class="fld-l">Price/Unit ‚Çπ</label><input type="number" id="pPU" value="${p?.pricePerUnit||''}" class="fld-i" placeholder="500" oninput="cU()"></div><div class="fld" style="margin:0"><label class="fld-l">Quantity</label><input type="number" id="pQt" value="${p?.quantity||''}" class="fld-i" placeholder="30" oninput="cU()"></div></div><div class="pp-calc"><span class="tm">Total:</span><span class="pp-calc-v" id="ppT">${isU?inr((p?.pricePerUnit||0)*(p?.quantity||0)):'‚Çπ0'}</span></div></div></div>${!p?`<div class="g2 mb12"><div class="fld"><label class="fld-l">Advance ‚Çπ</label><input type="number" id="pA" class="fld-i" placeholder="0"></div><div class="fld"><label class="fld-l">Pay Mode</label><select id="pM" class="fld-i">${opts(PM)}</select></div></div><div class="fld"><label class="fld-l">Advance Date</label><input type="date" id="pAD" value="${td()}" class="fld-i"></div>`:''}<div class="g2 mb12"><div class="fld"><label class="fld-l">Deadline</label><input type="date" id="pDl" value="${p?.deadline||''}" class="fld-i"></div><div class="fld"><label class="fld-l">Max Revisions</label><input type="number" id="pR" value="${p?.maxRevisions||3}" class="fld-i"></div></div><div class="fld"><label class="fld-l">Notes / Brief</label><textarea id="pNo" class="fld-i" placeholder="Brief, colors...">${p?.notes||''}</textarea></div><div class="fld"><label class="fld-l" style="display:flex;align-items:center;gap:6px;cursor:pointer;"><input type="checkbox" id="pPf" ${p?.portfolio?'checked':''}> Portfolio</label></div><button onclick="svPj()" class="btn btn-b btn-f">${ic(_.chk,'s')} ${p?'Update':'Create'}</button>`)}
function ePjM(ci,pi){const c=D.clients.find(x=>x.id===ci);const p=c?.projects?.find(x=>x.id===pi);if(p)oPjM(ci,p)}
function togPr(){$('fxB').style.display=$('pPr').value==='Fixed'?'':'none';$('unB').style.display=$('pPr').value!=='Fixed'?'':'none'}
function cU(){const u=parseInt($('pPU').value)||0,q=parseInt($('pQt').value)||0;$('ppT').textContent=inr(u*q)}
async function svPj(){const ci=parseInt($('pC').value),pi=$('pI').value,n=$('pN').value.trim(),pr=$('pPr').value;if(!n){tst('Enter name',0);return}let b=0,u=0,q=0;if(pr==='Fixed'){b=parseInt($('pB').value)||0;if(b<=0){tst('Enter budget',0);return}}else{u=parseInt($('pPU').value)||0;q=parseInt($('pQt').value)||0;if(u<=0||q<=0){tst('Enter price & qty',0);return}b=u*q}const c=D.clients.find(x=>x.id===ci);if(!c)return;if(!c.projects)c.projects=[];if(pi){const p=c.projects.find(x=>x.id===parseInt(pi));if(p)Object.assign(p,{name:n,type:$('pT').value,status:$('pS').value,pricing:pr,budget:b,pricePerUnit:u,quantity:q,deadline:$('pDl').value,maxRevisions:parseInt($('pR').value)||3,notes:$('pNo').value.trim(),portfolio:$('pPf').checked})}else{const adv=parseInt($('pA')?.value)||0;const advDate=$('pAD')?.value||td();c.projects.push({id:Date.now(),name:n,type:$('pT').value,status:$('pS').value,pricing:pr,budget:b,pricePerUnit:u,quantity:q,deadline:$('pDl').value,maxRevisions:parseInt($('pR').value)||3,revisions:0,notes:$('pNo').value.trim(),portfolio:$('pPf').checked,payments:adv>0?[{id:Date.now(),amount:adv,date:advDate,mode:$('pM').value}]:[],expenses:[],deliverables:[]})}cMo();await sav();render()}

// STATUS
function oStat(ci,pi){const c=D.clients.find(x=>x.id===ci);const p=c?.projects?.find(x=>x.id===pi);if(!p)return;sMo(`<div class="mo-t">Update Status</div><div class="mo-s">${p.name}</div><div style="display:flex;flex-direction:column;gap:8px;margin-bottom:16px;">${PS.map(s=>`<button onclick="setSt(${ci},${pi},'${s}')" class="btn ${p.status===s?'btn-b':'btn-o'} btn-f" style="justify-content:flex-start;"><span class="bg ${SC[s]}" style="margin-right:8px;">${s}</span>${s===p.status?'‚Üê Current':''}</button>`).join('')}</div><div class="fb mb12"><span class="fld-l" style="margin:0;">Revisions: ${p.revisions||0} / ${p.maxRevisions||3}</span><div class="btn-r"><button onclick="aRev(${ci},${pi},-1)" class="btn btn-g btn-s">‚àí</button><button onclick="aRev(${ci},${pi},1)" class="btn btn-g btn-s">+</button></div></div>`)}
async function setSt(ci,pi,s){const p=D.clients.find(x=>x.id===ci)?.projects?.find(x=>x.id===pi);if(!p)return;p.status=s;if(s==='Revision')p.revisions=(p.revisions||0)+1;cMo();await sav();render()}
async function aRev(ci,pi,d){const p=D.clients.find(x=>x.id===ci)?.projects?.find(x=>x.id===pi);if(!p)return;p.revisions=Math.max(0,(p.revisions||0)+d);await sav();oStat(ci,pi)}

// DELIVERABLES
function oDlv(ci,pi){const c=D.clients.find(x=>x.id===ci);const p=c?.projects?.find(x=>x.id===pi);if(!p)return;sMo(`<div class="mo-t">Deliverables</div><div class="mo-s">${p.name}</div><div class="fld"><label class="fld-l">Add File Type</label><select id="dvS" class="fld-i">${opts(DL)}</select></div><button onclick="aDlv(${ci},${pi})" class="btn btn-o btn-f mb16">${ic(_.plus,'xs')} Add</button><div>${(p.deliverables||[]).map((d,i)=>`<div style="display:flex;align-items:center;justify-content:space-between;padding:10px;background:var(--bg2);border-radius:10px;margin-bottom:6px;"><span class="tsm">${ic(_.fl,'xs')} ${d}</span><button class="hi-del" onclick="rDlv(${ci},${pi},${i})">${ic(_.x,'xs')}</button></div>`).join('')}</div>`)}
async function aDlv(ci,pi){const p=D.clients.find(x=>x.id===ci)?.projects?.find(x=>x.id===pi);if(!p)return;if(!p.deliverables)p.deliverables=[];p.deliverables.push($('dvS').value);await sav();oDlv(ci,pi)}
async function rDlv(ci,pi,i){const p=D.clients.find(x=>x.id===ci)?.projects?.find(x=>x.id===pi);if(!p)return;p.deliverables.splice(i,1);await sav();oDlv(ci,pi)}

// ‚òÖ PAYMENT ‚Äî with date recording ‚òÖ
function oPay(ci,pi){const c=D.clients.find(x=>x.id===ci);const p=c?.projects?.find(x=>x.id===pi);if(!p)return;sMo(`<div class="mo-t">Record Payment</div><div class="mo-s">${c.name} ‚Äî ${p.name}</div><div class="fld"><label class="fld-l">Amount ‚Çπ</label><input type="number" id="pyA" value="${pn(p)}" class="fld-i"></div><div class="g2 mb12"><div class="fld"><label class="fld-l">Date Received</label><input type="date" id="pyD" value="${td()}" class="fld-i"></div><div class="fld"><label class="fld-l">Mode</label><select id="pyM" class="fld-i">${opts(PM)}</select></div></div><button onclick="svPay(${ci},${pi})" class="btn btn-b btn-f">${ic(_.chk,'s')} Record Payment</button>`)}
async function svPay(ci,pi){const a=parseInt($('pyA').value)||0;if(a<=0){tst('Enter amount',0);return}const p=D.clients.find(c=>c.id===ci)?.projects?.find(x=>x.id===pi);if(!p)return;if(!p.payments)p.payments=[];p.payments.push({id:Date.now(),amount:a,date:$('pyD').value,mode:$('pyM').value});cMo();await sav();render()}
async function dPay(ci,pi,vi){if(!confirm('Delete?'))return;const p=D.clients.find(c=>c.id===ci)?.projects?.find(x=>x.id===pi);if(p){p.payments=(p.payments||[]).filter(v=>v.id!==vi);await sav();render()}}

// EXPENSE
function oExpP(ci,pi){const c=D.clients.find(x=>x.id===ci);const p=c?.projects?.find(x=>x.id===pi);if(!p)return;sMo(`<div class="mo-t">Add Expense</div><div class="mo-s">${c.name} ‚Äî ${p.name}</div><div style="background:rgba(220,38,38,.05);border:1px solid rgba(220,38,38,.15);border-radius:10px;padding:10px;margin-bottom:14px;"><div class="ts tr fb7">üîí Internal Only ‚Äî Won't appear on invoices</div></div><div class="fld"><label class="fld-l">Description</label><input type="text" id="exD" class="fld-i" placeholder="Stock photos, fonts..."></div><div class="g2 mb12"><div class="fld"><label class="fld-l">Amount ‚Çπ</label><input type="number" id="exA" class="fld-i" placeholder="0"></div><div class="fld"><label class="fld-l">Date</label><input type="date" id="exDt" value="${td()}" class="fld-i"></div></div><button onclick="svExp(${ci},${pi})" class="btn btn-b btn-f">${ic(_.chk,'s')} Add Expense</button>`)}
async function svExp(ci,pi){const a=parseInt($('exA').value)||0;if(a<=0){tst('Enter amount',0);return}const p=D.clients.find(c=>c.id===ci)?.projects?.find(x=>x.id===pi);if(!p)return;if(!p.expenses)p.expenses=[];p.expenses.push({id:Date.now(),amount:a,desc:$('exD').value.trim()||'Expense',date:$('exDt').value});cMo();await sav();render()}
async function dExp(ci,pi,ei){if(!confirm('Delete?'))return;const p=D.clients.find(c=>c.id===ci)?.projects?.find(x=>x.id===pi);if(p){p.expenses=(p.expenses||[]).filter(e=>e.id!==ei);await sav();render()}}

// WHATSAPP
function wa(ci){const c=D.clients.find(x=>x.id===ci);if(!c)return;const pjs=c.projects||[],bn=D.brand?.name||BN;let m=`Hi ${c.contact||c.name},\n\nProject update from ${bn}:\n\n`;pjs.forEach(p=>{const r=pn(p);m+=`üé® ${p.name}\n   Status: ${p.status}${p.deadline?' | Due: '+p.deadline:''}${r>0?' | Due: '+inr(r):' | ‚úÖ Paid'}\n\n`});const due=pjs.reduce((a,p)=>a+Math.max(0,pn(p)),0);if(due>0)m+=`üí∞ Total Due: ${inr(due)}\n`;m+=`\n‚Äî ${bn}`;const ph=(c.phone||'').replace(/\D/g,'');window.open(`https://wa.me/${ph||''}?text=${encodeURIComponent(m)}`,'_blank')}

// ‚òÖ‚òÖ‚òÖ PDF INVOICE ‚Äî NO EXPENSES, WITH PAYMENT DATES ‚òÖ‚òÖ‚òÖ
function loadJS(s){return new Promise((r,j)=>{const e=document.createElement('script');e.src=s;e.onload=r;e.onerror=j;document.head.appendChild(e)})}
async function ensurePDF(){if(!window.jspdf){tst('Loading PDF...');await loadJS('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');await loadJS('https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js')}}

// Full client invoice ‚Äî NO expenses shown
async function gInv(ci){const c=D.clients.find(x=>x.id===ci);if(!c)return;await ensurePDF();
try{const{jsPDF}=window.jspdf;const doc=new jsPDF();const bn=D.brand?.name||BN;
doc.setFillColor(124,58,237);doc.rect(0,0,210,42,'F');doc.setFillColor(168,85,247);doc.rect(0,38,210,4,'F');
doc.setTextColor(255);doc.setFontSize(22);doc.setFont('helvetica','bold');doc.text(bn,20,24);
doc.setFontSize(10);doc.setFont('helvetica','normal');doc.text('INVOICE',170,16);doc.setFontSize(8);doc.text('Date: '+new Date().toLocaleDateString('en-IN'),170,22);doc.text('INV-'+c.id.toString().slice(-6),170,28);
doc.setTextColor(50);doc.setFontSize(11);doc.setFont('helvetica','bold');doc.text('Bill To:',20,54);
doc.setFont('helvetica','normal');let y=62;doc.text(c.name,20,y);y+=7;
if(c.contact){doc.text(c.contact,20,y);y+=6}
if(c.phone){doc.text('+'+c.phone,20,y);y+=6}
if(c.email){doc.text(c.email,20,y);y+=6}

// Project table ‚Äî NO expenses column
const rows=(c.projects||[]).map(p=>[p.name,p.type||'Design',p.status,inr(gB(p)),inr(pdd(p)),inr(pn(p))]);
doc.autoTable({startY:y+8,head:[['Project','Type','Status','Budget','Paid','Balance']],body:rows,theme:'striped',headStyles:{fillColor:[124,58,237],textColor:255},styles:{fontSize:9},alternateRowStyles:{fillColor:[245,240,255]}});

const fy=doc.lastAutoTable.finalY+12;
const tv=(c.projects||[]).reduce((a,p)=>a+gB(p),0);
const tp=(c.projects||[]).reduce((a,p)=>a+pdd(p),0);
const bal=tv-tp;

doc.setFont('helvetica','bold');doc.setFontSize(11);
doc.setTextColor(50);doc.text('Total Budget: '+inr(tv),120,fy);
doc.setTextColor(5,150,105);doc.text('Total Paid: '+inr(tp),120,fy+8);
if(bal>0){doc.setTextColor(220,38,38);doc.text('Balance Due: '+inr(bal),120,fy+16)}
else{doc.setTextColor(5,150,105);doc.text('‚úì Fully Paid',120,fy+16)}

// ‚òÖ Payment history with dates ‚òÖ
let py=fy+30;
const allPays=[];
(c.projects||[]).forEach(p=>{(p.payments||[]).forEach((v,i)=>{allPays.push([p.name,i===0?'Advance':'Payment '+(i+1),fmtD(v.date),v.mode,inr(v.amount)])})});
if(allPays.length){
    doc.setTextColor(50);doc.setFont('helvetica','bold');doc.setFontSize(11);
    doc.text('Payment History',20,py);py+=4;
    doc.autoTable({startY:py,head:[['Project','Type','Date Received','Mode','Amount']],body:allPays,theme:'striped',headStyles:{fillColor:[5,150,105],textColor:255,fontSize:9},styles:{fontSize:8,cellPadding:4},columnStyles:{4:{halign:'right'}},alternateRowStyles:{fillColor:[236,253,245]}});
    py=doc.lastAutoTable.finalY+10;
}

// Status box
if(bal<=0){doc.setFillColor(236,253,245);doc.roundedRect(18,py,174,18,4,4,'F');doc.setTextColor(5,150,105);doc.setFontSize(13);doc.setFont('helvetica','bold');doc.text('FULLY PAID ‚Äî Thank You!',105,py+12,{align:'center'})}
else{doc.setFillColor(254,242,242);doc.roundedRect(18,py,174,18,4,4,'F');doc.setTextColor(220,38,38);doc.setFontSize(13);doc.setFont('helvetica','bold');doc.text('BALANCE DUE: '+inr(bal),105,py+12,{align:'center'})}

doc.setDrawColor(124,58,237);doc.setLineWidth(.5);doc.line(20,280,190,280);
doc.setTextColor(150);doc.setFontSize(7);doc.setFont('helvetica','normal');
doc.text('Generated by '+bn+' | '+new Date().toLocaleString(),20,286);
doc.text('Thank you for your business!',150,286);
doc.save(c.name.replace(/\s+/g,'_')+'_invoice.pdf');tst('Invoice saved!')}catch(e){console.error(e);tst('Failed',0)}}

// Single project invoice ‚Äî NO expenses, WITH payment dates
async function gPjInv(ci,pi){const c=D.clients.find(x=>x.id===ci);if(!c)return;const p=c.projects?.find(x=>x.id===pi);if(!p)return;await ensurePDF();
try{const{jsPDF}=window.jspdf;const doc=new jsPDF();const bn=D.brand?.name||BN;
const b=gB(p),sp=pdd(p),bal=b-sp;

doc.setFillColor(124,58,237);doc.rect(0,0,210,42,'F');doc.setFillColor(168,85,247);doc.rect(0,38,210,4,'F');
doc.setTextColor(255);doc.setFontSize(22);doc.setFont('helvetica','bold');doc.text(bn,20,20);
doc.setFontSize(10);doc.setFont('helvetica','normal');doc.text('PROJECT INVOICE',155,16);doc.setFontSize(8);doc.text('Date: '+new Date().toLocaleDateString('en-IN'),155,22);doc.text('INV-P-'+p.id.toString().slice(-6),155,28);doc.text(p.name,155,34);

doc.setTextColor(50);doc.setFontSize(11);doc.setFont('helvetica','bold');doc.text('Client:',20,54);
doc.setFont('helvetica','normal');let y=62;doc.setFontSize(12);doc.text(c.name,20,y);y+=7;doc.setFontSize(10);
if(c.contact){doc.text(c.contact,20,y);y+=6}
if(c.phone){doc.text('+'+c.phone,20,y);y+=6}
if(c.email){doc.text(c.email,20,y);y+=6}

// Project details box
y+=8;doc.setFillColor(245,240,255);doc.roundedRect(18,y-4,174,p.pricing&&p.pricing!=='Fixed'?42:34,4,4,'F');
doc.setDrawColor(124,58,237);doc.setLineWidth(.3);doc.roundedRect(18,y-4,174,p.pricing&&p.pricing!=='Fixed'?42:34,4,4,'S');
doc.setFontSize(14);doc.setFont('helvetica','bold');doc.setTextColor(124,58,237);doc.text(p.name,24,y+6);
doc.setFontSize(10);doc.setFont('helvetica','normal');doc.setTextColor(100);doc.text(p.type+' | '+p.status,24,y+14);
if(p.pricing&&p.pricing!=='Fixed'){doc.text(p.pricing+': '+inr(p.pricePerUnit)+' √ó '+p.quantity+' = '+inr(b),24,y+22);doc.setFontSize(13);doc.setFont('helvetica','bold');doc.setTextColor(50);doc.text('Total: '+inr(b),24,y+32);y+=46}
else{doc.setFontSize(13);doc.setFont('helvetica','bold');doc.setTextColor(50);doc.text('Budget: '+inr(b),24,y+22);y+=38}

// Summary ‚Äî NO expenses
doc.autoTable({startY:y,head:[['Description','Amount']],body:[['Project Budget',inr(b)],['Total Received',inr(sp)],['Balance Due',inr(bal)]],theme:'plain',headStyles:{fillColor:[124,58,237],textColor:255,fontStyle:'bold',fontSize:10},styles:{fontSize:10,cellPadding:6},columnStyles:{0:{fontStyle:'bold',cellWidth:110},1:{halign:'right',cellWidth:60}},didParseCell:function(d){if(d.section==='body'){if(d.row.index===1)d.cell.styles.textColor=[5,150,105];if(d.row.index===2&&bal>0)d.cell.styles.textColor=[220,38,38];if(d.row.index===2&&bal<=0)d.cell.styles.textColor=[5,150,105]}}});

let ty=doc.lastAutoTable.finalY+10;

// ‚òÖ Payment history with dates ‚òÖ
if((p.payments||[]).length){doc.setFontSize(12);doc.setFont('helvetica','bold');doc.setTextColor(50);doc.text('Payment History',20,ty);ty+=4;
const prows=(p.payments||[]).map((v,i)=>[i===0?'Advance Payment':'Payment '+(i+1),fmtD(v.date),v.mode,inr(v.amount)]);
doc.autoTable({startY:ty,head:[['Type','Date Received','Mode','Amount']],body:prows,theme:'striped',headStyles:{fillColor:[5,150,105],textColor:255,fontStyle:'bold',fontSize:9},styles:{fontSize:9,cellPadding:5},columnStyles:{3:{halign:'right'}},alternateRowStyles:{fillColor:[236,253,245]}});
ty=doc.lastAutoTable.finalY+10}

// Deliverables
if((p.deliverables||[]).length){doc.setFont('helvetica','bold');doc.setFontSize(11);doc.setTextColor(50);doc.text('Deliverables',20,ty);ty+=6;
(p.deliverables||[]).forEach(d=>{doc.setFont('helvetica','normal');doc.setFontSize(9);doc.text('‚Ä¢ '+d,24,ty);ty+=5}); ty+=5}

// Status
if(bal<=0){doc.setFillColor(236,253,245);doc.roundedRect(18,ty,174,18,4,4,'F');doc.setTextColor(5,150,105);doc.setFontSize(13);doc.setFont('helvetica','bold');doc.text('FULLY PAID ‚Äî Thank You!',105,ty+12,{align:'center'})}
else{doc.setFillColor(254,242,242);doc.roundedRect(18,ty,174,18,4,4,'F');doc.setTextColor(220,38,38);doc.setFontSize(13);doc.setFont('helvetica','bold');doc.text('BALANCE DUE: '+inr(bal),105,ty+12,{align:'center'})}

doc.setDrawColor(124,58,237);doc.setLineWidth(.5);doc.line(20,280,190,280);
doc.setTextColor(150);doc.setFontSize(7);doc.setFont('helvetica','normal');
doc.text('Generated by '+bn+' | '+new Date().toLocaleString(),20,286);
doc.text('Thank you for your business!',150,286);
doc.save(c.name.replace(/\s+/g,'_')+'_'+p.name.replace(/\s+/g,'_')+'_invoice.pdf');tst('Invoice saved!')}catch(e){console.error(e);tst('Failed',0)}}

init();
</script>
</body>
</html>
